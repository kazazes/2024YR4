<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>2024 YR4 Orbit Visualization</title>
    <link rel="icon" href="data:," />
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Asteroid 2024 YR4 Threat Assessment" />
    <meta
      property="og:description"
      content="Real-time visualization and threat assessment of asteroid 2024 YR4. Current Torino Scale: 3. Interactive 3D orbital visualization."
    />
    <meta property="og:image" content="og_threat_assessment.png" />
    <meta property="og:type" content="website" />
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Asteroid 2024 YR4 Threat Assessment" />
    <meta
      name="twitter:description"
      content="Real-time visualization and threat assessment of asteroid 2024 YR4. Current Torino Scale: 3. Interactive 3D orbital visualization."
    />
    <meta name="twitter:image" content="og_threat_assessment.png" />
    <!-- Retro digital font -->
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "VT323", monospace;
      }
      canvas {
        display: block;
      }
      /* Scanline effect */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.05) 0px,
          rgba(0, 0, 0, 0.05) 1px,
          transparent 1px,
          transparent 4px
        );
        pointer-events: none;
        animation: scanlines 20s infinite linear;
        opacity: 0.3;
      }
      @keyframes scanlines {
        from {
          background-position: 0 0;
        }
        to {
          background-position: 0 100%;
        }
      }
      /* CRT screen effect */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle at center,
          transparent 0%,
          rgba(0, 0, 0, 0.2) 90%,
          rgba(0, 0, 0, 0.4) 100%
        );
        pointer-events: none;
      }
      #info {
        position: absolute;
        top: 20px;
        width: 100%;
        color: #0f0;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 10px #0f0;
        animation: flicker 5s infinite;
        font-size: 1.2em;
      }
      @keyframes flicker {
        0% {
          opacity: 1;
        }
        49% {
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
        51% {
          opacity: 1;
        }
        59% {
          opacity: 1;
        }
        60% {
          opacity: 0.8;
        }
        61% {
          opacity: 1;
        }
      }
      /* Risk Info, Countdown & Sim Date */
      #risk-info {
        position: absolute;
        top: 80px;
        left: 20px;
        width: 400px;
        color: #f00;
        text-align: left;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(255, 0, 0, 0.8);
        background: rgba(20, 0, 0, 0.8);
        padding: 20px;
        border: 1px solid rgba(255, 0, 0, 0.3);
        font-size: 1.1em;
        z-index: 100;
      }
      #countdown,
      #simDate {
        margin-top: 10px;
        font-size: 1.2em;
      }
      .torino-3 {
        color: #f00;
        animation: warning-pulse 1.5s infinite;
      }
      @keyframes warning-pulse {
        0% {
          text-shadow: 0 0 10px #f00;
        }
        50% {
          text-shadow: 0 0 20px #f00, 0 0 40px #f00;
        }
        100% {
          text-shadow: 0 0 10px #f00;
        }
      }
      /* Flexbox controls panel */
      #controls {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: #0f0;
        background: rgba(0, 20, 0, 0.8);
        padding: 20px;
        border: 1px solid #0f0;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 1.2em;
      }
      #controls label {
        display: flex;
        align-items: center;
        margin: 5px 0;
        cursor: pointer;
      }
      /* Custom checkbox toggle */
      #controls input[type="checkbox"] {
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #0f0;
        background: transparent;
        margin-right: 8px;
        position: relative;
        cursor: pointer;
      }
      #controls input[type="checkbox"]:checked::before {
        content: "";
        position: absolute;
        width: 100%;
        height: 100%;
        background: #0f0;
        opacity: 0.5;
        top: 0;
        left: 0;
        border-radius: 50%;
      }
      #impactSelect {
        background: rgba(0, 20, 0, 0.8);
        color: #0f0;
        border: 1px solid #0f0;
        padding: 5px;
        margin: 10px 0;
        width: 100%;
        cursor: pointer;
        font-size: 1em;
      }
      #simulateImpact {
        background: #f00;
        color: white;
        border: none;
        padding: 10px 20px;
        margin-top: 10px;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
        letter-spacing: 2px;
        animation: button-pulse 2s infinite;
        width: 100%;
      }
      @keyframes button-pulse {
        0% {
          background-color: #f00;
          box-shadow: 0 0 10px #f00;
        }
        50% {
          background-color: #d00;
          box-shadow: 0 0 20px #f00;
        }
        100% {
          background-color: #f00;
          box-shadow: 0 0 10px #f00;
        }
      }
      /* Info button styling */
      #infoButton {
        background: #0f0;
        color: #000;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
        margin-top: 10px;
        font-size: 1em;
      }
      /* Warning overlay */
      .warning-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #f00;
        font-size: 24px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 3px;
        pointer-events: none;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .warning-overlay.active {
        opacity: 1;
      }
      /* Console UI styling */
      #console {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 800px;
        height: 60%;
        background: rgba(0, 20, 0, 0.9);
        border: 2px solid #0f0;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        color: #0f0;
        font-family: "VT323", monospace;
        padding: 20px;
        display: none;
        z-index: 1000;
        overflow: hidden;
        animation: console-glow 2s infinite;
      }
      @keyframes console-glow {
        0% {
          box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        50% {
          box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
        }
        100% {
          box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
      }
      #console-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #0f0;
        color: #000;
        padding: 5px 10px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #console-close {
        cursor: pointer;
        background: none;
        border: none;
        color: #000;
        font-weight: bold;
        font-size: 20px;
      }
      #console-content {
        height: calc(100% - 30px);
        margin-top: 30px;
        overflow-y: auto;
        padding: 10px;
        font-size: 14px;
        line-height: 1.4;
      }
      #console-content::-webkit-scrollbar {
        width: 8px;
      }
      #console-content::-webkit-scrollbar-track {
        background: rgba(0, 20, 0, 0.5);
      }
      #console-content::-webkit-scrollbar-thumb {
        background: #0f0;
      }
      .console-line {
        margin: 2px 0;
        opacity: 0;
        animation: type-in 0.1s forwards;
      }
      @keyframes type-in {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .console-error {
        color: #f00;
      }
      .console-warning {
        color: #ff0;
      }
      .console-success {
        color: #0f0;
      }
      #fetch-data {
        background: rgba(0, 20, 0, 0.8);
        color: #0f0;
        border: 1px solid #0f0;
        padding: 5px 10px;
        cursor: pointer;
        text-transform: uppercase;
        font-family: "VT323", monospace;
        margin-top: 10px;
        animation: button-glow 2s infinite;
      }
      @keyframes button-glow {
        0% {
          box-shadow: 0 0 5px #0f0;
        }
        50% {
          box-shadow: 0 0 15px #0f0;
        }
        100% {
          box-shadow: 0 0 5px #0f0;
        }
      }
      /* Progress bar for simulation */
      #impactProgress {
        display: none;
        width: 100%;
        margin-top: 10px;
        appearance: none;
        height: 10px;
      }
      #impactProgress::-webkit-progress-bar {
        background-color: #222;
        border-radius: 5px;
      }
      #impactProgress::-webkit-progress-value {
        background-color: #0f0;
        border-radius: 5px;
      }
      /* Glitch effect for risk info */
      @keyframes glitch {
        0% {
          text-shadow: 2px 2px 0 #f00;
        }
        50% {
          text-shadow: -2px -2px 0 #0ff;
        }
        100% {
          text-shadow: 2px 2px 0 #f00;
        }
      }
      .glitch {
        animation: glitch 0.5s infinite;
      }
      /* Tooltip style */
      .tooltip {
        position: relative;
        cursor: help;
      }
      .tooltip::after {
        content: attr(data-tip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: #0f0;
        padding: 4px 8px;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        border-radius: 4px;
        font-size: 0.8em;
      }
      .tooltip:hover::after {
        opacity: 1;
      }
      /* --- Modal Info Popup Styles --- */
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
      }
      .modal-content {
        background-color: #111;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #0f0;
        width: 80%;
        color: #0f0;
        font-family: "VT323", monospace;
        text-align: left;
        font-size: 1.2em;
      }
      .close-button {
        color: #0f0;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-button:hover,
      .close-button:focus {
        color: #fff;
      }
      /* Source links styling */
      .source-links {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 255, 0, 0.3);
      }
      .source-links a {
        color: #0f0;
        text-decoration: none;
        display: inline-block;
        padding: 5px 10px;
        border: 1px solid #0f0;
        margin: 5px;
        transition: all 0.3s ease;
      }
      .source-links a:hover {
        background: rgba(0, 255, 0, 0.1);
        box-shadow: 0 0 10px #0f0;
      }
      .source-links a::before {
        content: ">";
        margin-right: 5px;
      }
      /* Mobile responsiveness */
      @media screen and (max-width: 768px) {
        #controls {
          display: none;
        }

        #info {
          font-size: 1em;
        }

        #risk-info {
          width: 90%;
          left: 5%;
          font-size: 0.9em;
          padding: 10px;
        }

        /* Show only info button on mobile */
        #mobile-info-button {
          display: block;
          position: fixed;
          bottom: 20px;
          right: 20px;
          background: #0f0;
          color: #000;
          border: none;
          padding: 12px;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          cursor: pointer;
          font-weight: bold;
          font-size: 1.2em;
          box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .modal-content {
          margin: 5% auto;
          width: 90%;
          max-height: 90vh;
          overflow-y: auto;
          font-size: 1em;
          padding: 15px;
        }

        /* Adjust warning overlay for mobile */
        .warning-overlay {
          font-size: 18px;
          width: 90%;
          text-align: center;
        }
      }

      @media screen and (min-width: 769px) {
        #mobile-info-button {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="info">
      ⚠ Weyland-Yutani Corporation ⚠<br />Asteroid Threat Assessment System
    </div>
    <div id="risk-info">
      <!-- Risk info, countdown, and simulation date are injected here -->
      <div id="countdown"></div>
      <div id="simDate"></div>
    </div>
    <div id="controls">
      <div style="color: #0f0; margin-bottom: 15px">SYSTEM STATUS: ONLINE</div>
      <label>
        <input type="checkbox" id="showOrbit" checked />
        Orbital Path Display
      </label>
      <label>
        <input type="checkbox" id="animateAsteroid" checked />
        Real-time Tracking
      </label>
      <label>Impact Simulation:</label>
      <select id="impactSelect">
        <option value="-1">Select impact date...</option>
      </select>
      <button id="simulateImpact">Simulate Impact</button>
      <progress id="impactProgress" max="100" value="0"></progress>
      <button id="fetch-data">UPDATE ORBITAL DATA</button>
      <button id="infoButton">INFO</button>
    </div>
    <div class="warning-overlay" id="warningOverlay">
      ⚠ IMPACT SIMULATION IN PROGRESS ⚠<br />STAND BY FOR ANALYSIS
    </div>
    <button id="mobile-info-button">i</button>
    <div id="console">
      <div id="console-header">
        <span>WEYLAND-YUTANI ORBITAL DATABASE ACCESS</span>
        <button id="console-close">×</button>
      </div>
      <div id="console-content"></div>
    </div>
    <!-- Modal Info Popup -->
    <div id="infoPopup" class="modal">
      <div class="modal-content">
        <span class="close-button" id="closeInfoPopup">&times;</span>
        <h2>About This Visualization</h2>
        <p>
          Welcome to the Asteroid Threat Assessment System! This visualization
          is driven by data from the <code>ephemeris.json</code> file. The key
          parameters include:
        </p>
        <ul>
          <li>
            <strong>Orbital Elements:</strong> Semimajor axis (a), Eccentricity
            (e), Inclination (i), Longitude of Ascending Node (Ω), Argument of
            Periapsis (ω), and Mean Anomaly (M₀).
          </li>
          <li>
            <strong>Physical Parameters:</strong> Absolute magnitude, slope
            parameter, etc. (Some values may be null.)
          </li>
          <li>
            <strong>Impact Risk:</strong> Impact probability (shown as a
            percentage), Palermo scale, Torino scale, and predicted impact dates
            with probabilities (as percentages) from the JPL Sentry System.
          </li>
          <li>
            <strong>Observations:</strong> Total observations and the residual
            RMS error (indicating orbital uncertainty).
          </li>
        </ul>
        <p>
          The orbital position is computed via:
          <br /><em>r = a(1 - e²) / (1 + e cos f)</em> <br />with rotations
          applied for the argument of periapsis, inclination, and ascending
          node.
        </p>
        <p>
          Additionally, a live countdown to the next potential impact, a dynamic
          impact cone (visualizing uncertainty based on RMS), and a realistic
          Earth with its Moon are displayed.
          <br /><br />
          <em>Note:</em> This system is for informational and entertainment
          purposes only.
        </p>
        <div class="source-links">
          <h3>Official Data Sources:</h3>
          <a
            href="https://cneos.jpl.nasa.gov/sentry/details.html#?des=2024%20YR4"
            target="_blank"
          >
            CNEOS Sentry Details
          </a>
          <a
            href="https://ssd-api.jpl.nasa.gov/doc/sentry.html"
            target="_blank"
          >
            JPL Sentry API Documentation
          </a>
          <p style="font-size: 0.9em; margin-top: 10px">
            Data provided by NASA/JPL-Caltech Center for Near Earth Object
            Studies
          </p>
        </div>
      </div>
    </div>
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/"
        }
      }
    </script>
    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      (async function init() {
        // Load ephemeris data.
        const response = await fetch("ephemeris.json");
        const ephemeris = await response.json();

        // Extract orbital elements.
        const orbitalElements = ephemeris.orbital_elements;
        const a = orbitalElements.semimajor_axis.value;
        const e = orbitalElements.eccentricity;
        const inc = orbitalElements.inclination.value;
        const Omega = orbitalElements.longitude_ascending_node.value;
        const omega = orbitalElements.argument_periapsis.value;
        const M0 = orbitalElements.mean_anomaly.value;

        // Constants.
        const AU = 1.495978707e8; // km
        const deg2rad = Math.PI / 180;
        const EARTH_RADIUS = 6371; // km
        const displayedEarthRadius = EARTH_RADIUS * 1000; // For our Earth mesh

        // Set up scene, camera, renderer
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          1,
          1e12
        );
        camera.position.set(0, 2e8, 4e8);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxDistance = 1e11;
        controls.minDistance = EARTH_RADIUS * 5000;

        // Earth's orbital elements (J2000)
        const earthOrbitalElements = {
          a: 1.00000011, // AU
          e: 0.01671022,
          i: 0.00005, // degrees
          Omega: -11.26064, // degrees
          omega: 102.94719, // degrees
          M0: 100.46435, // degrees
        };

        // Orbital position function (reusable for both Earth and asteroid).
        function orbitalPosition(f, elements, scale = 1) {
          const a_km = elements.a * AU * scale;
          const e = elements.e;
          const r = (a_km * (1 - e * e)) / (1 + e * Math.cos(f));
          let x = r * Math.cos(f);
          let y = r * Math.sin(f);
          let z = 0;
          const cos_omega = Math.cos(elements.omega * deg2rad);
          const sin_omega = Math.sin(elements.omega * deg2rad);
          const x1 = x * cos_omega - y * sin_omega;
          const y1 = x * sin_omega + y * cos_omega;
          const z1 = z;
          const cos_inc = Math.cos(elements.i * deg2rad);
          const sin_inc = Math.sin(elements.i * deg2rad);
          const x2 = x1;
          const y2 = y1 * cos_inc - z1 * sin_inc;
          const z2 = y1 * sin_inc + z1 * cos_inc;
          const cos_Omega = Math.cos(elements.Omega * deg2rad);
          const sin_Omega = Math.sin(elements.Omega * deg2rad);
          const X = x2 * cos_Omega - y2 * sin_Omega;
          const Y = x2 * sin_Omega + y2 * cos_Omega;
          const Z = z2;
          return new THREE.Vector3(X, Y, Z);
        }

        // Create nominal orbit paths.
        // Earth's orbit
        const earthOrbitPoints = [];
        for (let f_deg = 0; f_deg <= 360; f_deg += 1) {
          earthOrbitPoints.push(
            orbitalPosition(f_deg * deg2rad, earthOrbitalElements)
          );
        }
        const earthOrbitGeometry = new THREE.BufferGeometry().setFromPoints(
          earthOrbitPoints
        );
        const earthOrbitMaterial = new THREE.LineBasicMaterial({
          color: 0x3366ff,
          linewidth: 2,
        });
        const earthOrbitLine = new THREE.Line(
          earthOrbitGeometry,
          earthOrbitMaterial
        );
        scene.add(earthOrbitLine);

        // Asteroid's orbit
        const asteroidElements = {
          a: a,
          e: e,
          i: inc,
          Omega: Omega,
          omega: omega,
          M0: M0,
        };
        const orbitPoints = [];
        for (let f_deg = 0; f_deg <= 360; f_deg += 1) {
          orbitPoints.push(orbitalPosition(f_deg * deg2rad, asteroidElements));
        }
        const orbitGeometry = new THREE.BufferGeometry().setFromPoints(
          orbitPoints
        );
        const orbitMaterial = new THREE.LineBasicMaterial({
          color: 0xff6666,
          linewidth: 2,
        });
        const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
        scene.add(orbitLine);

        // Starfield.
        const starGeometry = new THREE.BufferGeometry();
        const starVertices = [];
        const STAR_RADIUS = 1e10;
        const STAR_COUNT = 5000;
        for (let i = 0; i < STAR_COUNT; i++) {
          const theta = 2 * Math.PI * Math.random();
          const phi = Math.acos(2 * Math.random() - 1);
          const x = STAR_RADIUS * Math.sin(phi) * Math.cos(theta);
          const y = STAR_RADIUS * Math.sin(phi) * Math.sin(theta);
          const z = STAR_RADIUS * Math.cos(phi);
          starVertices.push(x, y, z);
        }
        starGeometry.setAttribute(
          "position",
          new THREE.Float32BufferAttribute(starVertices, 3)
        );
        const starMaterial = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 1.5,
          sizeAttenuation: false,
          opacity: 0.5,
          transparent: true,
        });
        const starField = new THREE.Points(starGeometry, starMaterial);
        scene.add(starField);

        // Sun.
        const sunGeometry = new THREE.SphereGeometry(696340 * 2, 32, 32);
        const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const sunMesh = new THREE.Mesh(sunGeometry, sunMaterial);
        scene.add(sunMesh);

        // Earth with realistic texture.
        const earthTexture = new THREE.TextureLoader().load(
          "https://upload.wikimedia.org/wikipedia/commons/9/97/The_Earth_seen_from_Apollo_17.jpg"
        );
        const earthMaterial = new THREE.MeshStandardMaterial({
          map: earthTexture,
          roughness: 0.3,
          metalness: 0.0,
          side: THREE.FrontSide,
          opacity: 1.0,
        });
        const earthGeometry = new THREE.SphereGeometry(
          displayedEarthRadius,
          32,
          32
        );
        const earthMesh = new THREE.Mesh(earthGeometry, earthMaterial);
        earthMesh.position.set(AU, 0, 0);
        scene.add(earthMesh);

        // Ambient & directional lights.
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
        sunLight.position.set(0, 0, 0);
        sunLight.target = earthMesh;
        scene.add(sunLight);
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5);
        scene.add(hemiLight);

        // Earth label.
        function makeLabel(text) {
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = 256;
          canvas.height = 64;
          context.fillStyle = "white";
          context.font = "24px VT323";
          context.textAlign = "center";
          context.fillText(text, 128, 32);
          const texture = new THREE.CanvasTexture(canvas);
          const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
          const sprite = new THREE.Sprite(spriteMaterial);
          sprite.scale.set(50000, 12500, 1);
          return sprite;
        }
        const earthLabel = makeLabel("Earth");
        earthMesh.add(earthLabel);
        earthLabel.position.set(0, displayedEarthRadius * 2, 0);

        // Add Moon.
        const moonOrbitRadius = displayedEarthRadius * 1.2;
        const moonMeshRadius = displayedEarthRadius * 0.05;
        const moonTexture = new THREE.TextureLoader().load(
          "https://upload.wikimedia.org/wikipedia/commons/e/e1/FullMoon2010.jpg"
        );
        const moonGeometry = new THREE.SphereGeometry(moonMeshRadius, 32, 32);
        const moonMaterial = new THREE.MeshStandardMaterial({
          map: moonTexture,
          roughness: 0.7,
        });
        const moonMesh = new THREE.Mesh(moonGeometry, moonMaterial);
        // Create a pivot for Moon orbit.
        const moonPivot = new THREE.Object3D();
        earthMesh.add(moonPivot);
        // Position Moon relative to the pivot.
        moonMesh.position.set(moonOrbitRadius, 0, 0);
        moonPivot.add(moonMesh);

        // Asteroid.
        const asteroidGeometry = new THREE.SphereGeometry(
          EARTH_RADIUS * 500,
          32,
          32
        );
        const asteroidMaterial = new THREE.MeshPhongMaterial({
          color: 0xff0000,
          emissive: 0x330000,
          shininess: 30,
          transparent: true,
          opacity: 0.9,
        });
        const asteroidMesh = new THREE.Mesh(asteroidGeometry, asteroidMaterial);

        // Enhanced glow effect
        function createGlowTexture() {
          const canvas = document.createElement("canvas");
          canvas.width = 128;
          canvas.height = 128;
          const ctx = canvas.getContext("2d");
          const gradient = ctx.createRadialGradient(64, 64, 0, 64, 64, 64);
          gradient.addColorStop(0, "rgba(255, 60, 60, 1)");
          gradient.addColorStop(0.4, "rgba(255, 60, 60, 0.5)");
          gradient.addColorStop(1, "rgba(255, 60, 60, 0)");
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, 128, 128);
          return canvas;
        }
        const asteroidGlow = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(createGlowTexture()),
            color: 0xff4444,
            transparent: true,
            blending: THREE.AdditiveBlending,
          })
        );
        asteroidGlow.scale.set(EARTH_RADIUS * 1000, EARTH_RADIUS * 1000, 1);
        asteroidMesh.add(asteroidGlow);
        scene.add(asteroidMesh);

        // Make label more visible
        const asteroidLabel = makeLabel("2024 YR4");
        asteroidMesh.add(asteroidLabel);
        asteroidLabel.position.set(0, EARTH_RADIUS * 600, 0);

        // Update risk info and countdown.
        const riskInfo = document.getElementById("risk-info");
        const torinoScale = ephemeris.impact_risk.torino_scale.maximum;
        const impactVelocity = ephemeris.impact_risk.impact_velocity;
        const potentialImpacts = ephemeris.impact_risk.potential_impacts;
        const lastUpdated = ephemeris.impact_risk.last_updated;
        const residualRMS = ephemeris.observations?.residual_rms || 0;
        const impactProbability = ephemeris.impact_risk.impact_probability;

        riskInfo.innerHTML = `
          <span class="torino-3">
            ⚠ THREAT ASSESSMENT: TORINO SCALE ${torinoScale} ⚠<br>
            <span style="font-size: 1em">
              ALERT: IMMEDIATE ASTRONOMICAL OBSERVATION REQUIRED<br>
              IMPACT VELOCITY: ${impactVelocity.value.toFixed(2)} ${
          impactVelocity.unit
        }<br>
              DETECTED IMPACT SCENARIOS: ${potentialImpacts.count}<br>
              PRIMARY IMPACT PROBABILITY: ${(impactProbability * 100).toFixed(
                2
              )}%<br>
              ${
                residualRMS
                  ? `CALC ERROR (Residual RMS): ${residualRMS.toFixed(3)}<br>`
                  : ""
              }
              <span style="font-size: 0.9em; opacity: 0.8;">
                LAST SYSTEM UPDATE: ${lastUpdated || "DATA UNAVAILABLE"}
              </span>
            </span>
          </span>
          <div id="countdown"></div>
          <div id="simDate"></div>
        `;

        // Compute simulation date relative to the asteroid's position.
        // Use epoch_description "2025-Jan-17.00" as our epoch.
        const epochDate = new Date("2025-01-17T00:00:00Z");
        // Compute orbital period using Kepler's third law: T(years) = a^(3/2).
        const orbitalPeriodYears = Math.pow(a, 1.5);
        const orbitalPeriodMs = orbitalPeriodYears * 365.25 * 24 * 3600 * 1000;

        // Set countdown based on first potential impact date.
        let nextImpactDate;
        if (potentialImpacts.dates && potentialImpacts.dates.length > 0) {
          nextImpactDate = new Date(potentialImpacts.dates[0].split(".")[0]);
        }
        function updateCountdown() {
          if (!nextImpactDate) return;
          const now = new Date();
          const diff = nextImpactDate - now;
          if (diff <= 0) {
            document.getElementById("countdown").textContent =
              "Impact imminent!";
            return;
          }
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
          const minutes = Math.floor((diff / (1000 * 60)) % 60);
          const seconds = Math.floor((diff / 1000) % 60);
          document.getElementById(
            "countdown"
          ).textContent = `Impact in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        setInterval(updateCountdown, 1000);

        // Update simulation date (linked to asteroid's position).
        let time = 0;
        const period = 60; // seconds for one simulation orbit (slowed down from 10 to 60)
        function updateSimDate() {
          // Fraction of simulation orbit completed.
          const fraction = (time % period) / period;
          // Simulated date = epochDate + fraction * real orbital period.
          const simDate = new Date(
            epochDate.getTime() + fraction * orbitalPeriodMs
          );
          // Format date to show only month and year
          const monthYear = simDate.toLocaleString("en-US", {
            month: "long",
            year: "numeric",
          });
          document.getElementById("simDate").textContent =
            "Simulation Date: " + monthYear;
        }

        // Impact Cone Visualization.
        let impactCone;
        function createImpactCone(earthPos, asteroidPos, rmsValue) {
          const direction = new THREE.Vector3().subVectors(
            asteroidPos,
            earthPos
          );
          const height = direction.length();
          const errorScale = 1e9;
          const baseRadius = rmsValue * errorScale;
          const coneGeometry = new THREE.CylinderGeometry(
            0,
            baseRadius,
            height,
            32,
            1,
            true
          );
          const coneMaterial = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            opacity: 0.2,
            transparent: true,
            side: THREE.DoubleSide,
          });
          const cone = new THREE.Mesh(coneGeometry, coneMaterial);
          const midPoint = new THREE.Vector3()
            .addVectors(earthPos, asteroidPos)
            .multiplyScalar(0.5);
          cone.position.copy(midPoint);
          cone.lookAt(asteroidPos);
          return cone;
        }

        // Impact markers and simulation.
        const impactMarkers = [];
        const impactDates = potentialImpacts.dates || [];
        const impactProbs = potentialImpacts.probabilities || [];
        for (let i = 0; i < impactDates.length; i++) {
          const markerGeometry = new THREE.SphereGeometry(
            EARTH_RADIUS * 500,
            16,
            16
          );
          const markerMaterial = new THREE.MeshBasicMaterial({
            color: 0xff0000,
            transparent: true,
            opacity: 0.3,
            blending: THREE.AdditiveBlending,
          });
          const marker = new THREE.Mesh(markerGeometry, markerMaterial);
          marker.position.copy(earthMesh.position);
          marker.visible = false;
          scene.add(marker);
          impactMarkers.push(marker);
        }
        const impactSelect = document.getElementById("impactSelect");
        impactSelect.innerHTML =
          `<option value="-1">Select impact date...</option>` +
          impactDates
            .map(
              (date, i) =>
                `<option value="${i}">${date} (Prob: ${(
                  impactProbs[i] * 100
                ).toFixed(2)}%)</option>`
            )
            .join("");

        const simulateButton = document.getElementById("simulateImpact");
        let currentImpactIndex = -1;
        let isSimulatingImpact = false;
        let simulationInterval, progressInterval;
        simulateButton.addEventListener("click", () => {
          const selectedIndex = parseInt(impactSelect.value);
          if (selectedIndex >= 0) {
            currentImpactIndex = selectedIndex;
            isSimulatingImpact = true;
            document.getElementById("risk-info").classList.add("glitch");
            const warningOverlay = document.getElementById("warningOverlay");
            warningOverlay.classList.add("active");
            const progressBar = document.getElementById("impactProgress");
            progressBar.style.display = "block";
            progressBar.value = 0;
            let progress = 0;
            progressInterval = setInterval(() => {
              progress += 1;
              progressBar.value = progress;
              if (progress >= 100) clearInterval(progressInterval);
            }, 100);
            const originalCameraPos = camera.position.clone();
            const earthPos = earthMesh.position;
            camera.position.set(
              earthPos.x + EARTH_RADIUS * 100,
              earthPos.y + EARTH_RADIUS * 100,
              earthPos.z + EARTH_RADIUS * 100
            );
            controls.target.copy(earthPos);
            impactMarkers.forEach((marker, i) => {
              marker.visible = i === selectedIndex;
            });
            simulationInterval = setTimeout(() => {
              camera.position.copy(originalCameraPos);
              controls.target.set(0, 0, 0);
            }, 10000);
          }
        });

        // Console UI functionality
        const consoleUI = {
          element: document.getElementById("console"),
          content: document.getElementById("console-content"),
          show() {
            this.element.style.display = "block";
          },
          hide() {
            this.element.style.display = "none";
          },
          clear() {
            this.content.innerHTML = "";
          },
          addLine(text, className = "") {
            const line = document.createElement("div");
            line.className = `console-line ${className}`;
            line.textContent = text;
            this.content.appendChild(line);
            this.content.scrollTop = this.content.scrollHeight;
          },
        };

        // Close console button
        document
          .getElementById("console-close")
          .addEventListener("click", () => {
            consoleUI.hide();
          });

        // Fetch data button functionality
        document
          .getElementById("fetch-data")
          .addEventListener("click", async () => {
            consoleUI.show();
            consoleUI.clear();
            consoleUI.addLine("Initializing connection to orbital database...");

            // Simulate a sequence of console messages
            const messages = [
              {
                text: "Establishing secure connection to NASA JPL...",
                delay: 800,
              },
              {
                text: "Connection established. Authenticating...",
                delay: 1200,
              },
              {
                text: "Authentication successful.",
                delay: 600,
                class: "console-success",
              },
              { text: "Requesting Sentry impact risk data...", delay: 1000 },
              {
                text: "ERROR: Connection refused by remote server",
                delay: 1500,
                class: "console-error",
              },
              { text: "Attempting reconnection...", delay: 800 },
              {
                text: "ERROR: NASA API endpoints no longer available",
                delay: 1000,
                class: "console-error",
              },
              {
                text: "SYSTEM NOTICE: As of 2024, direct access to NASA orbital data has been restricted.",
                delay: 1200,
                class: "console-warning",
              },
              {
                text: "Using cached data from last successful update (2024-02-06)",
                delay: 1000,
              },
              {
                text: "Database update failed. Please check official NASA websites for current data.",
                delay: 1500,
                class: "console-error",
              },
            ];

            // Display messages with delays
            let totalDelay = 0;
            messages.forEach((msg) => {
              totalDelay += msg.delay;
              setTimeout(() => {
                consoleUI.addLine(msg.text, msg.class || "");
              }, totalDelay);
            });
          });

        // Main animation loop.
        function animateScene() {
          requestAnimationFrame(animateScene);
          time += 0.016;

          // Update Earth position
          const earthF = ((time % period) / period) * 2 * Math.PI;
          const earthPos = orbitalPosition(earthF, earthOrbitalElements);
          earthMesh.position.copy(earthPos);

          // Update asteroid position relative to current Earth position
          const asteroidF = ((time % period) / period) * 2 * Math.PI;
          const asteroidPos = orbitalPosition(asteroidF, asteroidElements);
          asteroidMesh.position.copy(asteroidPos);

          updateSimDate(); // Update simulation date based on asteroid position.
          // Update Moon orbit.
          moonPivot.rotation.y += 0.005;

          // Update impact cone if asteroid is close to Earth
          const distance = asteroidPos.distanceTo(earthPos);
          if (distance < 1e8) {
            if (!impactCone) {
              impactCone = createImpactCone(
                earthPos,
                asteroidPos,
                ephemeris.observations?.residual_rms || 0
              );
              scene.add(impactCone);
            } else {
              const newCone = createImpactCone(
                earthPos,
                asteroidPos,
                ephemeris.observations?.residual_rms || 0
              );
              impactCone.geometry.dispose();
              impactCone.geometry = newCone.geometry;
              impactCone.position.copy(newCone.position);
              impactCone.quaternion.copy(newCone.quaternion);
            }
          } else if (impactCone) {
            scene.remove(impactCone);
            impactCone.geometry.dispose();
            impactCone = null;
          }

          controls.update();
          renderer.render(scene, camera);
        }
        animateScene();

        // Update RMS label on Earth.
        const rmsLabel = makeLabel(`RMS: ${residualRMS.toFixed(3)}`);
        rmsLabel.position.set(0, displayedEarthRadius * 2.5, 0);
        earthMesh.add(rmsLabel);

        window.addEventListener("resize", () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- Modal Info Popup ---
        const infoButton = document.getElementById("infoButton");
        const mobileInfoButton = document.getElementById("mobile-info-button");
        const infoPopup = document.getElementById("infoPopup");
        const closeInfoPopup = document.getElementById("closeInfoPopup");

        function showInfoPopup() {
          infoPopup.style.display = "block";
        }

        infoButton.addEventListener("click", showInfoPopup);
        mobileInfoButton.addEventListener("click", showInfoPopup);
        mobileInfoButton.addEventListener("touchend", (e) => {
          e.preventDefault();
          showInfoPopup();
        });

        closeInfoPopup.addEventListener("click", () => {
          infoPopup.style.display = "none";
        });
        closeInfoPopup.addEventListener("touchend", (e) => {
          e.preventDefault();
          infoPopup.style.display = "none";
        });

        window.addEventListener("click", (event) => {
          if (event.target === infoPopup) {
            infoPopup.style.display = "none";
          }
        });

        // Add touch controls for OrbitControls
        renderer.domElement.addEventListener("touchstart", (e) => {
          if (e.touches.length === 1) {
            controls.enableRotate = true;
            controls.enablePan = false;
          } else if (e.touches.length === 2) {
            controls.enableZoom = true;
            controls.enableRotate = false;
          }
        });

        renderer.domElement.addEventListener("touchend", () => {
          controls.enableRotate = true;
          controls.enableZoom = true;
          controls.enablePan = false;
        });
      })();
    </script>
  </body>
</html>
